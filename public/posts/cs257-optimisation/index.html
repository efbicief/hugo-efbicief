<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Code Optimisation - Parallelisation - Felix B</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="For this section of the notes, we will work through the following past question from the 2020 paper, using SIMD instructions.
The simulate function below is taken from a compute intensive simulation program written in C. void simulate() { //Loop 1 for (int i = 0; i &lt; N; i&#43;&#43;) { ax[i] = 0.0f; ay[i] = 0.0f; az[i] = 0.0f; } //Loop 2 for (int i = 0; i &lt; N; i&#43;&#43;) { for (int j = 0; j &lt; N; j&#43;&#43;) { float rx = x[j] - x[i]; float ry = y[j] - y[i]; float rz = z[j] - z[i]; float r2 = rx*rx &#43; ry*ry &#43; rz*rz &#43; eps; float r2inv = 1." />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Code Optimisation - Parallelisation" />
<meta property="og:description" content="For this section of the notes, we will work through the following past question from the 2020 paper, using SIMD instructions.
The simulate function below is taken from a compute intensive simulation program written in C. void simulate() { //Loop 1 for (int i = 0; i &lt; N; i&#43;&#43;) { ax[i] = 0.0f; ay[i] = 0.0f; az[i] = 0.0f; } //Loop 2 for (int i = 0; i &lt; N; i&#43;&#43;) { for (int j = 0; j &lt; N; j&#43;&#43;) { float rx = x[j] - x[i]; float ry = y[j] - y[i]; float rz = z[j] - z[i]; float r2 = rx*rx &#43; ry*ry &#43; rz*rz &#43; eps; float r2inv = 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://git.fbcf.xyz/posts/cs257-optimisation/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-06T10:22:41+01:00" />
<meta property="article:modified_time" content="2022-06-06T10:22:41+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Code Optimisation - Parallelisation"/>
<meta name="twitter:description" content="For this section of the notes, we will work through the following past question from the 2020 paper, using SIMD instructions.
The simulate function below is taken from a compute intensive simulation program written in C. void simulate() { //Loop 1 for (int i = 0; i &lt; N; i&#43;&#43;) { ax[i] = 0.0f; ay[i] = 0.0f; az[i] = 0.0f; } //Loop 2 for (int i = 0; i &lt; N; i&#43;&#43;) { for (int j = 0; j &lt; N; j&#43;&#43;) { float rx = x[j] - x[i]; float ry = y[j] - y[i]; float rz = z[j] - z[i]; float r2 = rx*rx &#43; ry*ry &#43; rz*rz &#43; eps; float r2inv = 1."/>
<script src="https://git.fbcf.xyz/js/feather.min.js"></script>
	
	
        <link href="https://git.fbcf.xyz/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://git.fbcf.xyz/css/main.46ba03325b5087e4bf8af8478b7cbcd704d0bbc30a81b70daa3b1f89234d557a.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://git.fbcf.xyz/css/dark.beec145b83af0d77445953d9c13ffa0b82ce322075bcd619e86b6afcafc1426f.css"  disabled />
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://git.fbcf.xyz/">Felix B</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/tags/project">Projects</a>
		
		<a href="/tags/blog">Blog Posts</a>
		
		<a href="/tags/index">Notes</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/tags">All Tags</a>
		
		| <a id="dark-mode-toggle" onclick="toggleTheme()" href=""></a>
		<script src="https://git.fbcf.xyz/js/themetoggle.js"></script>
		
	</nav>
	
</header>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
    integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4"
    crossorigin="anonymous"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
    integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<main>
	<article>
		<div class="title">
			<h1 class="title">Code Optimisation - Parallelisation</h1>
			<div class="meta">Posted on Jun 6, 2022
				
				
				
			</div>
		</div>

		

		<section class="body">
			<p>For this section of the notes, we will work through the following past question from the 2020 paper, using SIMD instructions.</p>
<blockquote>
<ul>
<li>The simulate function below is taken from a compute intensive simulation program written in C.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">simulate</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Loop 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      ax[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>      ay[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>      az[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Loop 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> N; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> rx <span style="color:#f92672">=</span> x[j] <span style="color:#f92672">-</span> x[i];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> ry <span style="color:#f92672">=</span> y[j] <span style="color:#f92672">-</span> y[i];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> rz <span style="color:#f92672">=</span> z[j] <span style="color:#f92672">-</span> z[i];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> r2 <span style="color:#f92672">=</span> rx<span style="color:#f92672">*</span>rx <span style="color:#f92672">+</span> ry<span style="color:#f92672">*</span>ry <span style="color:#f92672">+</span> rz<span style="color:#f92672">*</span>rz <span style="color:#f92672">+</span> eps;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> r2inv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">sqrt</span>(r2);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> r6inv <span style="color:#f92672">=</span> r2inv <span style="color:#f92672">*</span> r2inv <span style="color:#f92672">*</span> r2inv;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> s <span style="color:#f92672">=</span> m[j] <span style="color:#f92672">*</span> r6inv;
</span></span><span style="display:flex;"><span>        ax[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> rx;
</span></span><span style="display:flex;"><span>        ay[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> ry;
</span></span><span style="display:flex;"><span>        az[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> rz;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Loop 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      vx[i] <span style="color:#f92672">+=</span> dmp <span style="color:#f92672">*</span> (dt <span style="color:#f92672">*</span> ax[i]);
</span></span><span style="display:flex;"><span>      vy[i] <span style="color:#f92672">+=</span> dmp <span style="color:#f92672">*</span> (dt <span style="color:#f92672">*</span> ay[i]);
</span></span><span style="display:flex;"><span>      vz[i] <span style="color:#f92672">+=</span> dmp <span style="color:#f92672">*</span> (dt <span style="color:#f92672">*</span> az[i]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Loop 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      x[i] <span style="color:#f92672">+=</span> dt <span style="color:#f92672">*</span> vx[i];
</span></span><span style="display:flex;"><span>      y[i] <span style="color:#f92672">+=</span> dt <span style="color:#f92672">*</span> vy[i];
</span></span><span style="display:flex;"><span>      z[i] <span style="color:#f92672">+=</span> dt <span style="color:#f92672">*</span> vz[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x[i] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">||</span> x[i] <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>) vx[i] <span style="color:#f92672">*=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (y[i] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">||</span> y[i] <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>) vy[i] <span style="color:#f92672">*=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (z[i] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">||</span> z[i] <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>) vz[i] <span style="color:#f92672">*=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div></li>
<li>You may assume that the variables x,y,x,ax,ay,az,vx,vy,and vz are arrays of floats of length N that are aligned in memory. These arrays are not modified in any place other than the simulate function.</li>
<li>In answering this question you are expected to optimise the code by hand (this means that no #pragma functions or compiler options should be used) to improve single core performance.</li>
<li>You may assume that the target platform is a modern Intel processor, which has all MMX, SSE and AVX instructions available.</li>
<li>You might find it helpful to add comments to you code to explain your intentions.</li>
</ul>
</blockquote>
<ul>
<li>Optimise the loop identified as Loop 1 in the simulate function.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#75715e">// Before
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    ax[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>    ay[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>    az[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// After
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Using 128-bit vector units, which can hold 4 32-bit floats
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;immintrin.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> loopN <span style="color:#f92672">=</span> (N<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>; <span style="color:#75715e">// Number of items that can be vectorised
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> loopN; i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Write contents of zero_vec to ax, ay and az + offset i
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_mm_store_ps</span>(ax<span style="color:#f92672">+</span>i, <span style="color:#a6e22e">_mm_setzero_ps</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_mm_store_ps</span>(ay<span style="color:#f92672">+</span>i, <span style="color:#a6e22e">_mm_setzero_ps</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_mm_store_ps</span>(ax<span style="color:#f92672">+</span>i, <span style="color:#a6e22e">_mm_setzero_ps</span>());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    ax[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>    ay[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>    az[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div>
<ul>
<li>Optimise the loop identified as Loop 2 in the simulate function.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#75715e">// Before
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> N; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> rx <span style="color:#f92672">=</span> x[j] <span style="color:#f92672">-</span> x[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> ry <span style="color:#f92672">=</span> y[j] <span style="color:#f92672">-</span> y[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> rz <span style="color:#f92672">=</span> z[j] <span style="color:#f92672">-</span> z[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> r2 <span style="color:#f92672">=</span> rx<span style="color:#f92672">*</span>rx <span style="color:#f92672">+</span> ry<span style="color:#f92672">*</span>ry <span style="color:#f92672">+</span> rz<span style="color:#f92672">*</span>rz <span style="color:#f92672">+</span> eps;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> r2inv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">sqrt</span>(r2);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> r6inv <span style="color:#f92672">=</span> r2inv <span style="color:#f92672">*</span> r2inv <span style="color:#f92672">*</span> r2inv;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> s <span style="color:#f92672">=</span> m[j] <span style="color:#f92672">*</span> r6inv;
</span></span><span style="display:flex;"><span>      ax[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> rx;
</span></span><span style="display:flex;"><span>      ay[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> ry;
</span></span><span style="display:flex;"><span>      az[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> rz;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// After
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;immintrin.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> loopN <span style="color:#f92672">=</span> (N<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__m128</span> eps_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_set1_ps</span>(eps);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> loopN; i<span style="color:#f92672">+=</span><span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Loading needed vectors (i-indexed)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">__m128</span> ax_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(ax<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> ay_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(ay<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> az_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(az<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> xi_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(x<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> yi_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(y<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> zi_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(z<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> loopN; j<span style="color:#f92672">+=</span><span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Loading needed vectors (j-indexed)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">__m128</span> xj_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(x<span style="color:#f92672">+</span>j);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> yj_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(y<span style="color:#f92672">+</span>j);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> zj_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(z<span style="color:#f92672">+</span>j);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> m_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(m<span style="color:#f92672">+</span>j);
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Computation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">__m128</span> rx <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_ps</span>(xj, xi);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> ry <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_ps</span>(yj, yi);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> rz <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_ps</span>(zj, zi);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> r2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(<span style="color:#a6e22e">_mm_add_ps</span>(<span style="color:#a6e22e">_mm_mul_ps</span>(rx, rx), <span style="color:#a6e22e">_mm_mul_ps</span>(ry, ry)), <span style="color:#a6e22e">_mm_add_ps</span>(<span style="color:#a6e22e">_mm_mul_ps</span>(rz, rz), eps_vec));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> r2inv <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_invsqrt</span>(r2);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> r6inv <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_mul_ps</span>(<span style="color:#a6e22e">_mm_mul_ps</span>(r2inv, r2inv), r2inv);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> s <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_mul_ps</span>(m_vec, r6inv);
</span></span><span style="display:flex;"><span>      ax_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(ax_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(s, rx));
</span></span><span style="display:flex;"><span>      ay_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(ay_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(s, ry));
</span></span><span style="display:flex;"><span>      az_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(az_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(s, rz));
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Storing back into arrays
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">_mm_store_ps</span>(ax<span style="color:#f92672">+</span>i, ax_vec);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_mm_store_ps</span>(ay<span style="color:#f92672">+</span>i, ay_vec);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_mm_store_ps</span>(az<span style="color:#f92672">+</span>i, az_vec);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (; j <span style="color:#f92672">&lt;</span> N; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> rx <span style="color:#f92672">=</span> x[j] <span style="color:#f92672">-</span> x[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> ry <span style="color:#f92672">=</span> y[j] <span style="color:#f92672">-</span> y[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> rz <span style="color:#f92672">=</span> z[j] <span style="color:#f92672">-</span> z[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> r2 <span style="color:#f92672">=</span> rx<span style="color:#f92672">*</span>rx <span style="color:#f92672">+</span> ry<span style="color:#f92672">*</span>ry <span style="color:#f92672">+</span> rz<span style="color:#f92672">*</span>rz <span style="color:#f92672">+</span> eps;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> r2inv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">sqrt</span>(r2);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> r6inv <span style="color:#f92672">=</span> r2inv <span style="color:#f92672">*</span> r2inv <span style="color:#f92672">*</span> r2inv;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> s <span style="color:#f92672">=</span> m[j] <span style="color:#f92672">*</span> r6inv;
</span></span><span style="display:flex;"><span>      ax[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> rx;
</span></span><span style="display:flex;"><span>      ay[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> ry;
</span></span><span style="display:flex;"><span>      az[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> rz;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Cleanup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> loopN; j<span style="color:#f92672">+=</span><span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Loading needed vectors (j-indexed)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">__m128</span> xj_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(x<span style="color:#f92672">+</span>j);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> yj_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(y<span style="color:#f92672">+</span>j);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> zj_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(z<span style="color:#f92672">+</span>j);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> m_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(m<span style="color:#f92672">+</span>j);
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Computation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">__m128</span> rx <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_ps</span>(xj, xi);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> ry <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_ps</span>(yj, yi);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> rz <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_sub_ps</span>(zj, zi);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> r2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(<span style="color:#a6e22e">_mm_add_ps</span>(<span style="color:#a6e22e">_mm_mul_ps</span>(rx, rx), <span style="color:#a6e22e">_mm_mul_ps</span>(ry, ry)), <span style="color:#a6e22e">_mm_add_ps</span>(<span style="color:#a6e22e">_mm_mul_ps</span>(rz, rz), eps_vec));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> r2inv <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_invsqrt</span>(r2);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> r6inv <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_mul_ps</span>(<span style="color:#a6e22e">_mm_mul_ps</span>(r2inv, r2inv), r2inv);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">__m128</span> s <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_mul_ps</span>(m_vec, r6inv);
</span></span><span style="display:flex;"><span>      ax_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(ax_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(s, rx));
</span></span><span style="display:flex;"><span>      ay_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(ay_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(s, ry));
</span></span><span style="display:flex;"><span>      az_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(az_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(s, rz));
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Storing back into arrays
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">_mm_store_ps</span>(ax<span style="color:#f92672">+</span>i, ax_vec);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_mm_store_ps</span>(ay<span style="color:#f92672">+</span>i, ay_vec);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">_mm_store_ps</span>(az<span style="color:#f92672">+</span>i, az_vec);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (; j <span style="color:#f92672">&lt;</span> N; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> rx <span style="color:#f92672">=</span> x[j] <span style="color:#f92672">-</span> x[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> ry <span style="color:#f92672">=</span> y[j] <span style="color:#f92672">-</span> y[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> rz <span style="color:#f92672">=</span> z[j] <span style="color:#f92672">-</span> z[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> r2 <span style="color:#f92672">=</span> rx<span style="color:#f92672">*</span>rx <span style="color:#f92672">+</span> ry<span style="color:#f92672">*</span>ry <span style="color:#f92672">+</span> rz<span style="color:#f92672">*</span>rz <span style="color:#f92672">+</span> eps;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> r2inv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">sqrt</span>(r2);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> r6inv <span style="color:#f92672">=</span> r2inv <span style="color:#f92672">*</span> r2inv <span style="color:#f92672">*</span> r2inv;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">float</span> s <span style="color:#f92672">=</span> m[j] <span style="color:#f92672">*</span> r6inv;
</span></span><span style="display:flex;"><span>      ax[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> rx;
</span></span><span style="display:flex;"><span>      ay[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> ry;
</span></span><span style="display:flex;"><span>      az[i] <span style="color:#f92672">+=</span> s <span style="color:#f92672">*</span> rz;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span></code></pre></div>
<ul>
<li>Optimise the loop identified as Loop 3 in the simulate function.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#75715e">// Before
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    vx[i] <span style="color:#f92672">+=</span> dmp <span style="color:#f92672">*</span> (dt <span style="color:#f92672">*</span> ax[i]);
</span></span><span style="display:flex;"><span>    vy[i] <span style="color:#f92672">+=</span> dmp <span style="color:#f92672">*</span> (dt <span style="color:#f92672">*</span> ay[i]);
</span></span><span style="display:flex;"><span>    vz[i] <span style="color:#f92672">+=</span> dmp <span style="color:#f92672">*</span> (dt <span style="color:#f92672">*</span> az[i]);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// After
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;immintrin.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> loopN <span style="color:#f92672">=</span> (N<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__m128</span> dmp_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_set1_ps</span>(dmp);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__m128</span> dt_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_set1_ps</span>(dt);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Load vectors
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">__m128</span> vx_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(vx<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> vy_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(vy<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> vz_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(vx<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> ax_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(ax<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> ay_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(ay<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> az_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(az<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Calculate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    vx_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(vx_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(dmp_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(dt_vec, ax_vec)));
</span></span><span style="display:flex;"><span>    vy_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(vy_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(dmp_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(dt_vec, ay_vec)));
</span></span><span style="display:flex;"><span>    vz_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(vz_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(dmp_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(dt_vec, az_vec)));
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Store
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_mm_store_ps</span>(vx<span style="color:#f92672">+</span>i, vx_vec);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_mm_store_ps</span>(vy<span style="color:#f92672">+</span>i, vy_vec);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_mm_store_ps</span>(vz<span style="color:#f92672">+</span>i, vz_vec);
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div>
<ul>
<li>Optimise the loop identified as Loop 4 in the simulate function.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#75715e">// Before
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      x[i] <span style="color:#f92672">+=</span> dt <span style="color:#f92672">*</span> vx[i];
</span></span><span style="display:flex;"><span>      y[i] <span style="color:#f92672">+=</span> dt <span style="color:#f92672">*</span> vy[i];
</span></span><span style="display:flex;"><span>      z[i] <span style="color:#f92672">+=</span> dt <span style="color:#f92672">*</span> vz[i];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (x[i] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">||</span> x[i] <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>) vx[i] <span style="color:#f92672">*=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (y[i] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">||</span> y[i] <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>) vy[i] <span style="color:#f92672">*=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (z[i] <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1.0f</span> <span style="color:#f92672">||</span> z[i] <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>) vz[i] <span style="color:#f92672">*=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// After
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;immintrin.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> loopN <span style="color:#f92672">=</span> (N<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__m128</span> dt_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_set1_ps</span>(dt);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__m128</span> onevec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_set1_ps</span>(<span style="color:#ae81ff">1.0f</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__m128</span> negonevec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_m_set1_ps</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1.0f</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Load vectors
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">__m128</span> x_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(x<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> y_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(y<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> z_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(z<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> vx_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(vx<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> vy_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(vy<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> vz_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_load_ps</span>(vz<span style="color:#f92672">+</span>i);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Compute
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    x_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(x_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(dt_vec, vx_vec));
</span></span><span style="display:flex;"><span>    y_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(y_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(dt_vec, vy_vec));
</span></span><span style="display:flex;"><span>    z_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_add_ps</span>(z_vec, <span style="color:#a6e22e">_mm_mul_ps</span>(dt_vec, vz_vec));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> mask_x <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_and_ps</span>(<span style="color:#a6e22e">_mm_cmpge_ps</span>(x_vec, onevec), <span style="color:#a6e22e">_mm_cmple_ps</span>(x_vec, negonevec));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> branch1vx <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_mul_ps</span>(vx_vec, negonevec);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> vx_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_blendv_ps</span>(vx_vec, branch1vx, mask_x);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> mask_y <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_and_ps</span>(<span style="color:#a6e22e">_mm_cmpge_ps</span>(y_vec, onevec), <span style="color:#a6e22e">_mm_cmple_ps</span>(y_vec, negonevec));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> branch1vy <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_mul_ps</span>(vy_vec, negonevec);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> vy_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_blendv_ps</span>(vy_vec, branch1vy, mask_y);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> mask_z <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_and_ps</span>(<span style="color:#a6e22e">_mm_cmpge_ps</span>(z_vec, onevec), <span style="color:#a6e22e">_mm_cmple_ps</span>(z_vec, negonevec));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> branch1vx <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_mul_ps</span>(vz_vec, negonevec);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__m128</span> vz_vec <span style="color:#f92672">=</span> <span style="color:#a6e22e">_mm_blendv_ps</span>(vz_vec, branch1vz, mask_z);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Store
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_mm_store_ps</span>(vx<span style="color:#f92672">+</span>i, vx_vec);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_mm_store_ps</span>(vy<span style="color:#f92672">+</span>i, vy_vec);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_mm_store_ps</span>(vz<span style="color:#f92672">+</span>i, vz_vec);
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div>
<p><a href="/posts/cs257-index/">All topics ⟶</a></p>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					<li>
						
						<a href="/tags/cs257">CS257</a>
						
						<a href="/tags/architecture">Architecture</a>
						
						<a href="/tags/optimisation">Optimisation</a>
						
						<a href="/tags/notes">Notes</a>
						
					</li>
				</ul>
			</nav>
			
			
		</div>

		

	</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/efbicief" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2023  © Felix B |  <a
      href="https://github.com/efbicief/archie-efbicief">Archie Theme</a> (fork) | Made with ❤️ using <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
  feather.replace()
</script></div>
    </body>
</html>
